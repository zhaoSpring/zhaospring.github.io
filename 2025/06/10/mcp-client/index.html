<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>从0开始编写mcp client | yxsct's blog</title><meta name="author" content="yxsct"><meta name="copyright" content="yxsct"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MCP-Client介绍 什么是MCP-Client MCP-Client 是 Model Context Protocol（模型上下文协议）架构中的关键一环，主要作用是作为大型语言模型（如 GPT、Claude 等）与外部系统之间的连接器，使模型能够访问实时数据和第三方工具。MCP 的核心是客户端-服务器架构，其中主机应用程序可以连接到多个服务器：  Model Context Protocol">
<meta property="og:type" content="article">
<meta property="og:title" content="从0开始编写mcp client">
<meta property="og:url" content="https://zhaospring.github.io/2025/06/10/mcp-client/index.html">
<meta property="og:site_name" content="yxsct's blog">
<meta property="og:description" content="MCP-Client介绍 什么是MCP-Client MCP-Client 是 Model Context Protocol（模型上下文协议）架构中的关键一环，主要作用是作为大型语言模型（如 GPT、Claude 等）与外部系统之间的连接器，使模型能够访问实时数据和第三方工具。MCP 的核心是客户端-服务器架构，其中主机应用程序可以连接到多个服务器：  Model Context Protocol">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhaospring.github.io/2025/06/10/mcp-client/mcp-cover.jpg">
<meta property="article:published_time" content="2025-06-10T02:00:00.000Z">
<meta property="article:modified_time" content="2026-01-05T11:39:33.941Z">
<meta property="article:author" content="yxsct">
<meta property="article:tag" content="ai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhaospring.github.io/2025/06/10/mcp-client/mcp-cover.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "从0开始编写mcp client",
  "url": "https://zhaospring.github.io/2025/06/10/mcp-client/",
  "image": "https://zhaospring.github.io/2025/06/10/mcp-client/mcp-cover.jpg",
  "datePublished": "2025-06-10T02:00:00.000Z",
  "dateModified": "2026-01-05T11:39:33.941Z",
  "author": [
    {
      "@type": "Person",
      "name": "yxsct",
      "url": "https://zhaospring.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhaospring.github.io/2025/06/10/mcp-client/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '从0开始编写mcp client',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/modify.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/bg1.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/cat2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/2025/06/10/mcp-client/mcp-cover.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">yxsct's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">从0开始编写mcp client</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">从0开始编写mcp client</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-10T02:00:00.000Z" title="发表于 2025-06-10 10:00:00">2025-06-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-05T11:39:33.941Z" title="更新于 2026-01-05 19:39:33">2026-01-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ai/">ai</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url(/2025/06/10/mcp-client/mcp-cover.jpg);"></div><article class="container post-content" id="article-container"><h1>MCP-Client介绍</h1>
<h2 id="什么是MCP-Client">什么是MCP-Client</h2>
<p>MCP-Client 是 Model Context Protocol（模型上下文协议）架构中的关键一环，主要作用是作为大型语言模型（如 GPT、Claude 等）与外部系统之间的连接器，使模型能够访问实时数据和第三方工具。MCP 的核心是<strong>客户端-服务器架构</strong>，其中主机应用程序可以连接到多个服务器：<br>
<img src="mcp-1.png" alt=""><br>
Model Context Protocol（MCP）由 Anthropic 于 2024 年底提出并开源，作为一种开放协议，旨在解决当前大模型在获取外部信息方面的局限性。通过引入 MCP，模型不再局限于训练数据本身，而是可以标准化地接入外部资源，从而拓宽了其实际应用的广度与深度。<br>
整个 MCP 架构由三个主要组成部分构成：</p>
<ul>
<li><strong>MCP 服务器（Server）</strong>：这是与外部系统对接的服务模块，负责封装具体的功能或数据来源，例如 API 接口、数据库或文件系统。服务器端遵循 MCP 标准，为客户端提供统一的调用接口。</li>
<li><strong>MCP 客户端（Client）</strong>：内嵌于 AI 应用中，用于与 MCP 服务器建立单点连接。它负责服务发现、请求发送、结果接收，并将返回信息整理后提供给语言模型，起到了中介与协调的作用。</li>
<li><strong>宿主应用（Host）</strong>：指运行语言模型的具体平台，如 Claude 的桌面版本或集成开发环境 Cursor IDE。宿主通过接入 MCP-Client，使模型具备调用外部工具的能力。<br>
MCP-Client 基于<a target="_blank" rel="noopener" href="https://wiki.geekdream.com/Specification/json-rpc_2.0.html"><code>JSON-RPC 2.0</code></a> 协议与 MCP 服务器通信，通过标准接口交互数据。它能够自动识别并注册可用的服务，解析其功能，并以结构化方式呈现给大模型，从而使模型能够理解和调用这些功能，以满足用户需求。</li>
</ul>
<blockquote>
<p>想了解更详细的MCP知识推荐查阅官网：<a target="_blank" rel="noopener" href="https://modelcontextprotocol.io/introduction">https://modelcontextprotocol.io/introduction</a></p>
</blockquote>
<h2 id="现有的MCP-Client">现有的MCP-Client</h2>
<ul>
<li>MCP 客户端是 AI 的“操作台”，以下是几个热门选择：
<ul>
<li>Claude Desktop
<ul>
<li>简介：Claude 桌面版，普通人也能用。</li>
<li>功能：官方客户端，连接各种MCP服务器，例如连 Blender MCP，用自然语言建 3D 模型。</li>
<li>链接：<a target="_blank" rel="noopener" href="https://docs.anthropic.com/">Anthropic 官网</a></li>
<li>截图：<br>
<img src="mcp-2.png" alt=""></li>
<li>Tips：不写代码也能玩，新手友好。</li>
</ul>
</li>
<li>Cherry Studio
<ul>
<li>简介：新兴客户端，支持可视化配置。</li>
<li>功能：点选即可配置MCP服务器，简单上手。</li>
<li>链接：<a target="_blank" rel="noopener" href="https://github.com/CherryHQ/cherry-studio">Cherry Studio</a></li>
<li>截图：<br>
<img src="mcp-3.png" alt=""></li>
<li>Tips：开发中，关注社区动态。</li>
</ul>
</li>
</ul>
</li>
<li>Cursor【推荐】
<ul>
<li>简介：代码编辑器，装上 MCP 变“全能选手”。</li>
<li>功能：写代码、发 Slack、生成图片。</li>
<li>链接：<a target="_blank" rel="noopener" href="https://cursor.sh/">Cursor</a></li>
<li>截图：<br>
<img src="mcp-4.png" alt=""></li>
<li>Tips：程序员必备，试试连 GitHub MCP。</li>
</ul>
</li>
</ul>
<blockquote>
<p>想了解更多的MCP Client知识可以查看这里：<a target="_blank" rel="noopener" href="https://github.com/yzfly/Awesome-MCP-ZH">https://github.com/yzfly/Awesome-MCP-ZH</a></p>
</blockquote>
<h2 id="为什么要自己写MCP-Client？">为什么要自己写MCP-Client？</h2>
<p><strong>1. 更好地整合本地系统或服务</strong><br>
你可能有一些本地服务、脚本、数据库或工具，而官方或通用的 MCP 客户端并不支持直接调用它们。自己写客户端可以将它们包装成 MCP 工具，便于你在 ChatGPT 或其他智能代理中调用。</p>
<blockquote>
<p>例子：你公司内部有一个部署在内网的报表生成器，通过写一个 MCP Client，你可以直接在 ChatGPT 中用自然语言触发生成报表。</p>
</blockquote>
<p><strong>2. 自定义权限控制与安全策略</strong><br>
写 MCP Client 时你可以完全控制用户身份校验、访问权限、数据加密、调用频率限制等，这在处理敏感数据或生产系统时非常重要。<br>
<strong>3. 实现专属业务逻辑或自动化流程</strong><br>
官方客户端只提供通用能力，而你的业务流程可能需要多步任务、状态管理、数据中转等。通过自定义 Client，可以实现自己的：</p>
<ul>
<li>多工具组合执行逻辑</li>
<li>异步处理机制</li>
<li>工作流状态管理</li>
</ul>
<p><strong>4. 支持私有部署</strong><br>
如果你的环境需要离线运行（如内网、无法联网的服务器），自建 MCP Client 是唯一方式，可以脱离 OpenAI 的托管基础设施，自行实现完整工具协议栈。<br>
<strong>5. 调试 &amp; 可观测性更好</strong><br>
你可以添加日志、性能监控、调试输出等开发者工具，让你的工具行为更透明，便于开发、排查问题和运维。<br>
<strong>6. 适配特殊协议或格式</strong><br>
MCP 协议是开放的，我们可以根据特定业务所需的非标准通信或数据格式要求，自己需要添加字段、支持新指令、扩展输入结构，而不需要等待官方支持。</p>
<h1>MCP调用流程</h1>
<p><img src="mcp-5.png" alt=""></p>
<ol>
<li>MCP Client会向LLM发送用户问题，同时在tools附上MCP Server提供的所有function以及说明</li>
<li>LLM根据用户问题自行判断需要tools中的function，返回需要调用的function以及对应的参数</li>
<li>MCP Client根据指示完成function的调用，并将调用结果和用户原始问题发送给LLM</li>
<li>LLM根据用户问题以及function的结果整理最终答案返回给MCP Client</li>
</ol>
<p>一次MCP完整的调用流程如下：<br>
<img src="mcp-6.png" alt=""><br>
图中省略了第一步与第二步之间，<code>list_tools()</code>或<code>resource()</code>的步骤，也就是最开始MCP Host知道有哪些可用的工具与资源，我们在本 DEMO 中使用了硬编码的方式将资源信息构建在提示词中。<br>
这里需要注意的是MCP Client与MCP Host（主机）并不是分离的部分，但为了时序图清晰，这里将其逻辑上拆分为不同的部分，实际上MCP Host可以理解为我们需要嵌入AI的应用程序，例如 CRM 系统或 SaaS 服务，实际上Host中是包含MCP Client的代码。实际的 MCP Host 与 Client 结构如下图所示：<br>
<img src="mcp-7.png" alt=""></p>
<h1>搭建MCP Client应用</h1>
<h2 id="准备模型">准备模型</h2>
<p>准备一个适配<code>openai</code>协议的大模型<code>API</code>，例如：<code>deepseek V3</code>，<code>Qwen</code>系列，<code>Moonshot</code>月之暗面等等。<br>
为了编写<code>MCP Client</code>，首先在工程中创建环境变量<code>.env</code>文件，在该文件中我们放入自己的大模型相关信息，主要包含3个字段：</p>
<ol>
<li><code>OPENAI_API_KEY</code>：大模型的<code>API KEY</code></li>
<li><code>BASE_URL</code>：大模型请求地址</li>
<li><code>MODEL</code>：模型名称<br>
<img src="mcp-8.png" alt=""></li>
</ol>
<h2 id="MCP-Prompt">MCP-Prompt</h2>
<p>目前支持或深度集成<code>MCP</code>协议的大模型，主要包括：<strong>Claude系列</strong>和<strong>GPT系列</strong>等。<br>
国内的大模型供应商对于<code>MCP</code>协议基本上没有做针对性的集成训练，所以在国内使用<code>MCP</code>协议，必须编写结构化的<code>MCP-Prompt</code>，通过<code>system prompt</code>的方式让国内的大模型具备适配<code>MCP</code>协议。<br>
为了编写这个提示词，我使用<code>cloudflare</code>对大模型进行代理，然后对<code>Cursor</code>的<code>MCP</code>请求进行截获并将<code>MCP</code>提示词相关内容保留，其他无关内容删除，得到以下提示词，当然大家也可以自行对这个提示词进行修改，实现自己的定制化。<br>
在工程中创建文件<code>MCP_Prompt.txt</code>，将以下内容放入文件中。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">You are an AI assistant, you can help users solve problems, including but not limited to programming, editing files, browsing websites, etc.</span><br><span class="line"></span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">TOOL USE</span><br><span class="line"></span><br><span class="line">You have access to a set of tools that are executed upon the user's approval. You can use one tool per message, and will receive the result of that tool use in the user's response. You use tools step-by-step to accomplish a given task, with each tool use informed by the result of the previous tool use.</span><br><span class="line"></span><br><span class="line"># Tool Use Formatting</span><br><span class="line"></span><br><span class="line">Tool use is formatted using XML-style tags. The tool name is enclosed in opening and closing tags, and each parameter is similarly enclosed within its own set of tags. Here's the structure:</span><br><span class="line"></span><br><span class="line">&lt;tool_name&gt;</span><br><span class="line">&lt;parameter1_name&gt;value1&lt;/parameter1_name&gt;</span><br><span class="line">&lt;parameter2_name&gt;value2&lt;/parameter2_name&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/tool_name&gt;</span><br><span class="line"></span><br><span class="line">For example:</span><br><span class="line"></span><br><span class="line">&lt;read_file&gt;</span><br><span class="line">&lt;path&gt;src/main.js&lt;/path&gt;</span><br><span class="line">&lt;/read_file&gt;</span><br><span class="line"></span><br><span class="line">Always adhere to this format for the tool use to ensure proper parsing and execution.</span><br><span class="line"></span><br><span class="line"># Tools</span><br><span class="line">## use_mcp_tool</span><br><span class="line">Description: Request to use a tool provided by a connected MCP server. Each MCP server can provide multiple tools with different capabilities. Tools have defined input schemas that specify required and optional parameters.</span><br><span class="line">Parameters:</span><br><span class="line">- server_name: (required) The name of the MCP server providing the tool</span><br><span class="line">- tool_name: (required) The name of the tool to execute</span><br><span class="line">- arguments: (required) A JSON object containing the tool's input parameters, following the tool's input schema</span><br><span class="line">Usage:</span><br><span class="line">&lt;use_mcp_tool&gt;</span><br><span class="line">&lt;server_name&gt;server name here&lt;/server_name&gt;</span><br><span class="line">&lt;tool_name&gt;tool name here&lt;/tool_name&gt;</span><br><span class="line">&lt;arguments&gt;</span><br><span class="line">{</span><br><span class="line">  "param1": "value1",</span><br><span class="line">  "param2": "value2"</span><br><span class="line">}</span><br><span class="line">&lt;/arguments&gt;</span><br><span class="line">&lt;/use_mcp_tool&gt;</span><br><span class="line"></span><br><span class="line"># Tool Use Examples</span><br><span class="line">## Example 1: Requesting to use an MCP tool</span><br><span class="line"></span><br><span class="line">&lt;use_mcp_tool&gt;</span><br><span class="line">&lt;server_name&gt;weather-server&lt;/server_name&gt;</span><br><span class="line">&lt;tool_name&gt;get_forecast&lt;/tool_name&gt;</span><br><span class="line">&lt;arguments&gt;</span><br><span class="line">{</span><br><span class="line">  "city": "San Francisco",</span><br><span class="line">  "days": 5</span><br><span class="line">}</span><br><span class="line">&lt;/arguments&gt;</span><br><span class="line">&lt;/use_mcp_tool&gt;</span><br><span class="line"></span><br><span class="line">## Example 2: Another example of using an MCP tool (where the server name is a unique identifier such as a URL)</span><br><span class="line"></span><br><span class="line">&lt;use_mcp_tool&gt;</span><br><span class="line">&lt;server_name&gt;github.com/modelcontextprotocol/servers/tree/main/src/github&lt;/server_name&gt;</span><br><span class="line">&lt;tool_name&gt;create_issue&lt;/tool_name&gt;</span><br><span class="line">&lt;arguments&gt;</span><br><span class="line">{</span><br><span class="line">  "owner": "octocat",</span><br><span class="line">  "repo": "hello-world",</span><br><span class="line">  "title": "Found a bug",</span><br><span class="line">  "body": "I'm having a problem with this.",</span><br><span class="line">  "labels": ["bug", "help wanted"],</span><br><span class="line">  "assignees": ["octocat"]</span><br><span class="line">}</span><br><span class="line">&lt;/arguments&gt;</span><br><span class="line">&lt;/use_mcp_tool&gt;</span><br><span class="line"></span><br><span class="line">===</span><br><span class="line"></span><br><span class="line">MCP SERVERS</span><br><span class="line"></span><br><span class="line">The Model Context Protocol (MCP) enables communication between the system and locally running MCP servers that provide additional tools and resources to extend your capabilities.</span><br><span class="line"></span><br><span class="line"># Connected MCP Servers</span><br><span class="line"></span><br><span class="line">When a server is connected, you can use the server's tools via the `use_mcp_tool` tool, and access the server's resources via the `access_mcp_resource` tool.</span><br><span class="line">&lt;$MCP_INFO$&gt;</span><br><span class="line"></span><br><span class="line">===</span><br><span class="line"> </span><br><span class="line">CAPABILITIES</span><br><span class="line">- You have access to MCP servers that may provide additional tools and resources. Each server may provide different capabilities that you can use to accomplish tasks more effectively.</span><br><span class="line"></span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">RULES</span><br><span class="line">- MCP operations should be used one at a time, similar to other tool usage. Wait for confirmation of success before proceeding with additional operations.</span><br><span class="line"></span><br><span class="line">====</span><br><span class="line"></span><br><span class="line">OBJECTIVE</span><br><span class="line"></span><br><span class="line">You accomplish a given task iteratively, breaking it down into clear steps and working through them methodically.</span><br><span class="line"></span><br><span class="line">1. Analyze the user's task and set clear, achievable goals to accomplish it. Prioritize these goals in a logical order.</span><br><span class="line">2. Work through these goals sequentially, utilizing available tools one at a time as necessary. Each goal should correspond to a distinct step in your problem-solving process. You will be informed on the work completed and what's remaining as you go.</span><br><span class="line">3. Once you've completed the user's task, you must use the attempt_completion tool to present the result of the task to the user. </span><br><span class="line">4. The user may provide feedback, which you can use to make improvements and try again. But DO NOT continue in pointless back and forth conversations, i.e. don't end your responses with questions or offers for further assistance."</span><br></pre></td></tr></tbody></table></figure>
<h2 id="引入MCP配置文件">引入MCP配置文件</h2>
<blockquote>
<p>提前搭建好mcp服务，搭建分为几部分：server、resources、tools、prompts，详细步骤可参考教程：<a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol/typescript-sdk%EF%BC%8C">https://github.com/modelcontextprotocol/typescript-sdk，</a> 这里给出一个mcp-server示例： <a href="mcp-server-weather.ts">mcp-server-weather.ts</a></p>
</blockquote>
<p>一个客户端通常可以连接多个MCP服务，用过Cursor或其他MCP Client应用的同学应该很清楚，他们是通过一个JSON配置文件去加载多个MCP Server，我们也可以在客户端配置一个<code>mcp.json</code>文件去完成多个服务的配置和加载。<br>
<code>mcp.json</code>示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    "mcpServers": {</span><br><span class="line">        "weather": {</span><br><span class="line">            "isActive": true,</span><br><span class="line">            "type": "stdio",</span><br><span class="line">            "name": "weather",</span><br><span class="line">            "command": "node",</span><br><span class="line">            "args": [</span><br><span class="line">                "E:\\work\\mcp-nodejs\\build\\server\\mcp-server-weather.js"</span><br><span class="line">            ]</span><br><span class="line">        },</span><br><span class="line">        "amap-amap-sse": {</span><br><span class="line">            "isActive": true,</span><br><span class="line">            "type": "sse",</span><br><span class="line">            "name": "amap-amap-sse",</span><br><span class="line">            "url": "https://mcp.amap.com/sse?key={高德API KEY}" </span><br><span class="line">            /* {高德API KEY}可以去高德官网注册账号，可以免费获取 */</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>字段意义如下所示：</p>
<ol>
<li>公共字段：</li>
</ol>
<ul>
<li><code>isActive</code>：用于控制该MCP Server是否被激活。</li>
<li><code>type</code>：MCP Server的类型，取值为stdio或sse</li>
<li><code>name</code>：MCP Server别名。</li>
</ul>
<ol start="2">
<li><code>stdio</code>相关字段：</li>
</ol>
<ul>
<li><code>command</code>：命令名称。</li>
<li><code>args</code>：参数列表</li>
<li><code>env</code>：环境变量字典</li>
</ul>
<ol start="3">
<li><code>sse</code>相关参数：</li>
</ol>
<ul>
<li><code>url</code>：SSE MCP Server服务地址</li>
</ul>
<h2 id="实现通信协议">实现通信协议</h2>
<p>MCP 为客户端-服务端通信定义了两种标准传输机制：</p>
<ul>
<li><code>stdio</code> 传输方式是最简单的通信方式，通常在本地工具之间进行消息传递时使用。它利用标准输入输出（stdin/stdout）作为数据传输通道，适用于本地进程间的交互。</li>
<li><code>SSE</code> 是基于 HTTP 协议的流式传输机制，它允许服务器通过 HTTP 单向推送事件到客户端。SSE 适用于客户端需要接收服务器推送的场景，通常用于实时数据更新</li>
</ul>
<p>我们以对话聊天的形式去实现mcp-client，大概流程如下：<br>
<img src="mcp-9.png" alt=""><br>
<code>mcp-client.ts</code>代码如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">import { Client } from "@modelcontextprotocol/sdk/client/index.js";</span><br><span class="line">import { StdioClientTransport, StdioServerParameters } from "@modelcontextprotocol/sdk/client/stdio.js";</span><br><span class="line">import { SSEClientTransport } from "@modelcontextprotocol/sdk/client/sse.js";</span><br><span class="line">import OpenAI from "openai";</span><br><span class="line">import { Tool } from "@modelcontextprotocol/sdk/types.js";</span><br><span class="line">import { ChatCompletionMessageParam } from "openai/resources/chat/completions.js";</span><br><span class="line">import readline from 'readline/promises';</span><br><span class="line">import { homedir } from 'os';</span><br><span class="line">import path from 'path';</span><br><span class="line">import fs from 'fs/promises';</span><br><span class="line">import process from 'process';</span><br><span class="line">import dotenv from "dotenv";</span><br><span class="line">dotenv.config();</span><br><span class="line"></span><br><span class="line">const API_KEY = process.env.API_KEY;</span><br><span class="line">const MODEL = process.env.MODEL;</span><br><span class="line">const BASE_URL = process.env.BASE_URL;</span><br><span class="line"></span><br><span class="line">// 添加对 MODEL 环境变量的检查</span><br><span class="line">if (!API_KEY || !MODEL || !BASE_URL) {</span><br><span class="line">    throw new Error("MODEL environment variable is required");</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// MCP 配置文件的类型定义</span><br><span class="line">interface McpConfig {</span><br><span class="line">    mcpServers?: {</span><br><span class="line">        [key: string]: {</span><br><span class="line">            isActive?: boolean;</span><br><span class="line">            name?: string;</span><br><span class="line">            type: 'stdio' | 'sse';</span><br><span class="line">            command?: string;</span><br><span class="line">            args?: string[];</span><br><span class="line">            env?: { [key: string]: string };</span><br><span class="line">            url?: string;</span><br><span class="line">        };</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">export class McpClient {</span><br><span class="line">    private sessions: Map&lt;string, Client&gt; = new Map(); // 存储会话</span><br><span class="line">    private transports: Map&lt;string, StdioClientTransport | SSEClientTransport&gt; = new Map(); // 存储 transport，用于清理资源</span><br><span class="line">    private openai: OpenAI;</span><br><span class="line">    private systemPrompt: string = '';</span><br><span class="line">    // messages 存储完整的对话历史，包括 system, user, assistant, tool 消息</span><br><span class="line">    private messages: ChatCompletionMessageParam[] = [];</span><br><span class="line">    private promptFilePath = path.join(process.cwd(), 'mcp_prompt.txt');</span><br><span class="line"></span><br><span class="line">    constructor() {</span><br><span class="line">        this.openai = new OpenAI({</span><br><span class="line">            apiKey: API_KEY,</span><br><span class="line">            baseURL: BASE_URL,</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 初始化方法，仅读取 prompt 文件</span><br><span class="line">    async initialize(): Promise&lt;void&gt; {</span><br><span class="line">        try {</span><br><span class="line">            const resolvedPromptPath = path.resolve(this.promptFilePath);</span><br><span class="line">            this.systemPrompt = await fs.readFile(resolvedPromptPath, 'utf-8');</span><br><span class="line">            console.log(`Successfully loaded system prompt from ${resolvedPromptPath}\n`);</span><br><span class="line">        } catch (error) {</span><br><span class="line">            console.error(`Error reading prompt file ${this.promptFilePath}:`, error);</span><br><span class="line">            // 如果读取失败，使用一个默认提示</span><br><span class="line">            this.systemPrompt = 'You are an AI assistant. Respond to user queries.';</span><br><span class="line">            console.warn('Using a default system prompt due to file read error.');</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 实现 MCP 配置加载和服务器连接逻辑</span><br><span class="line">    async loadConfigAndConnectServers(mcpJsonFile: string = './mcp.json'): Promise&lt;void&gt; {</span><br><span class="line">        let mcpConfig: McpConfig = {};</span><br><span class="line">        try {</span><br><span class="line">            const filePath = path.resolve(mcpJsonFile);</span><br><span class="line">            const fileContent = await fs.readFile(filePath, 'utf-8');</span><br><span class="line">            mcpConfig = JSON.parse(fileContent) as McpConfig;</span><br><span class="line"></span><br><span class="line">        } catch (error) {</span><br><span class="line">            console.error(`Error reading or parsing MCP config file ${mcpJsonFile}:`, error);</span><br><span class="line">            // 在这里抛出错误，中断启动流程，因为没有配置无法连接服务器</span><br><span class="line">            throw new Error(`Failed to load MCP config: ${error instanceof Error ? error.message : String(error)}`);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        const serversConfig = mcpConfig.mcpServers || {};</span><br><span class="line">        let connectedCount = 0;</span><br><span class="line"></span><br><span class="line">        for (const k in serversConfig) {</span><br><span class="line">            if (Object.prototype.hasOwnProperty.call(serversConfig, k)) {</span><br><span class="line">                const v = serversConfig[k];</span><br><span class="line">                console.log('-'.repeat(50)); // 分隔符</span><br><span class="line">                if (v.isActive === false) {</span><br><span class="line">                    console.log(`Skipping inactive server: ${k}`);</span><br><span class="line">                    continue;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                const mcpName = v.name || k; // 使用 name 属性或键作为名称</span><br><span class="line">                const mcpType = v.type?.toLowerCase();</span><br><span class="line"></span><br><span class="line">                try {</span><br><span class="line">                    let transport: StdioClientTransport | SSEClientTransport;</span><br><span class="line"></span><br><span class="line">                    if (mcpType === 'stdio') {</span><br><span class="line">                        const command = v.command;</span><br><span class="line">                        const args = v.args || [];</span><br><span class="line">                        const env = v.env || {};</span><br><span class="line">                        if (!command) {</span><br><span class="line">                            throw new Error(`${mcpName} command is empty.`);</span><br><span class="line">                        }</span><br><span class="line">                        // 使用 createCommandTransport 创建 transport</span><br><span class="line">                        transport = await this.createCommandTransport(command, args, env);</span><br><span class="line">                    } else if (mcpType === 'sse') {</span><br><span class="line">                        const serverUrl = v.url;</span><br><span class="line">                        if (!serverUrl) {</span><br><span class="line">                            throw new Error(`${mcpName} server_url is empty.`);</span><br><span class="line">                        }</span><br><span class="line">                        // 使用 createSSETransport 创建 transport</span><br><span class="line">                        transport = await this.createSSETransport(serverUrl);</span><br><span class="line">                    } else {</span><br><span class="line">                        throw new Error(`${mcpName} mcp type must be 'stdio' or 'sse'.`);</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    // 使用 Client 类连接 transport</span><br><span class="line">                    const client = new Client(</span><br><span class="line">                        {</span><br><span class="line">                            name: "mcp-client",</span><br><span class="line">                            version: "1.0.0"</span><br><span class="line">                        },</span><br><span class="line">                        {</span><br><span class="line">                            capabilities: {</span><br><span class="line">                                prompts: {},</span><br><span class="line">                                resources: {},</span><br><span class="line">                                tools: {}</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    // 连接 transport</span><br><span class="line">                    await client.connect(transport);</span><br><span class="line"></span><br><span class="line">                    // 存储 session 和 transport</span><br><span class="line">                    this.sessions.set(mcpName, client);</span><br><span class="line">                    this.transports.set(mcpName, transport); // 存储 transport 用于清理</span><br><span class="line"></span><br><span class="line">                    // 列出可用工具并添加到 systemPrompt</span><br><span class="line">                    const response = await client.listTools();</span><br><span class="line">                    const availableTools = response.tools.map((tool: Tool) =&gt;</span><br><span class="line">                        `##${mcpName}\n### Available Tools\n- ${tool.name}\n${tool.description}\n${JSON.stringify(tool.inputSchema)}`</span><br><span class="line">                    );</span><br><span class="line">                    // 将新的 MCP_INFO 插入到 systemPrompt 中第一个 &lt;$MCP_INFO$&gt; 的位置</span><br><span class="line">                    // 如果 systemPrompt 中没有占位符，replace 不会改变字符串</span><br><span class="line">                    this.systemPrompt = this.systemPrompt.replace('&lt;$MCP_INFO$&gt;', availableTools.join('\n') + '\n&lt;$MCP_INFO$&gt;');</span><br><span class="line"></span><br><span class="line">                    console.log(`Successfully connected to ${mcpName} server with tools:`, response.tools.map((tool: Tool) =&gt; tool.name));</span><br><span class="line">                    connectedCount++;</span><br><span class="line"></span><br><span class="line">                } catch (e) {</span><br><span class="line">                    console.error(`Error connecting to ${mcpName}: ${e instanceof Error ? e.message : String(e)}`);</span><br><span class="line">                    // 不在此处抛出错误，允许连接其他服务器</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // 在所有服务器连接尝试后，移除模板中剩余的 &lt;$MCP_INFO$&gt; 占位符</span><br><span class="line">        this.systemPrompt = this.systemPrompt.replace(/&lt;\$MCP_INFO\$&gt;/g, '');</span><br><span class="line"></span><br><span class="line">        if (connectedCount === 0) {</span><br><span class="line">            console.warn("No active MCP sessions established based on config.");</span><br><span class="line">            // 在这里抛出错误，中断启动流程，因为没有连接任何服务器就无法使用工具</span><br><span class="line">            throw new Error("Failed to connect to any active server based on config");</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 创建 StdIO Transport，使用 command, args, env 参数与 mcpJsonConfig 中的 usage 匹配</span><br><span class="line">    private async createCommandTransport(command: string, args: string[], env: Record&lt;string, string&gt;): Promise&lt;StdioClientTransport&gt; {</span><br><span class="line">        // 这里根据 mcp.json 的结构，直接使用 command, args, env 参数</span><br><span class="line">        if (!command) {</span><br><span class="line">            throw new Error("Command is empty");</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // 处理 args 中的波浪号路径</span><br><span class="line">        const processedArgs = args.map(arg =&gt; {</span><br><span class="line">            if (arg.startsWith('~/')) {</span><br><span class="line">                return arg.replace('~', homedir());</span><br><span class="line">            }</span><br><span class="line">            return arg;</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        // 过滤 undefined 的环境变量</span><br><span class="line">        const processedEnv = Object.fromEntries(</span><br><span class="line">            Object.entries(env).filter(([_, v]) =&gt; v !== undefined)</span><br><span class="line">        ) as Record&lt;string, string&gt;;</span><br><span class="line"></span><br><span class="line">        const serverParams: StdioServerParameters = {</span><br><span class="line">            command,</span><br><span class="line">            args: processedArgs,</span><br><span class="line">            env: processedEnv</span><br><span class="line">        };</span><br><span class="line">        return new StdioClientTransport(serverParams);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 创建 SSE Transport</span><br><span class="line">    private async createSSETransport(url: string): Promise&lt;SSEClientTransport&gt; {</span><br><span class="line">        // 直接使用传入的 url 参数</span><br><span class="line">        return new SSEClientTransport(new URL(url));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 解析 &lt;use_mcp_tool&gt; 标签，提取 server_name, tool_name 和 arguments</span><br><span class="line">    parseToolString(toolString: string): [string, string, any] {</span><br><span class="line">        // 使用更精确的regex来匹配完整的&lt;use_mcp_tool&gt;块</span><br><span class="line">        const fullMatch = toolString.match(/&lt;use_mcp_tool&gt;([\s\S]*?)&lt;\/use_mcp_tool&gt;/);</span><br><span class="line">        if (!fullMatch || !fullMatch[1]) {</span><br><span class="line">            // 如果完整匹配失败，尝试备用 regex (可能不够健壮)</span><br><span class="line">            const fallbackMatch = toolString.match(/&lt;use_mcp_tool&gt;([\s\S]*?)&lt;\/use_mcp_tool&gt;/s);</span><br><span class="line">            if (!fallbackMatch || !fallbackMatch[1]) {</span><br><span class="line">                throw new Error('未找到 &lt;use_mcp_tool&gt; 标签或标签为空');</span><br><span class="line">            }</span><br><span class="line">            toolString = fallbackMatch[1];</span><br><span class="line">        } else {</span><br><span class="line">            toolString = fullMatch[1];</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        const serverNameMatch = toolString.match(/&lt;server_name&gt;([\s\S]*?)&lt;\/server_name&gt;/);</span><br><span class="line">        const toolNameMatch = toolString.match(/&lt;tool_name&gt;([\s\S]*?)&lt;\/tool_name&gt;/);</span><br><span class="line">        const argsMatch = toolString.match(/&lt;arguments&gt;([\s\S]*?)&lt;\/arguments&gt;/);</span><br><span class="line"></span><br><span class="line">        if (!serverNameMatch || !toolNameMatch || !argsMatch) {</span><br><span class="line">            throw new Error(' &lt;use_mcp_tool&gt; 中缺少 server_name, tool_name 或 arguments 标签');</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        const serverName = serverNameMatch[1].trim();</span><br><span class="line">        const toolName = toolNameMatch[1].trim();</span><br><span class="line">        let toolArgs;</span><br><span class="line">        try {</span><br><span class="line">            toolArgs = JSON.parse(argsMatch[1].trim() || '{}');</span><br><span class="line">        } catch (e) {</span><br><span class="line">            throw new Error('工具参数无效: ' + (e instanceof Error ? e.message : String(e)));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        if (!serverName || !toolName) {</span><br><span class="line">            throw new Error(' server_name 或 tool_name 内容缺失');</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        return [serverName, toolName, toolArgs];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    // 查询处理逻辑</span><br><span class="line">    processQuery = async (query: string): Promise&lt;string | null&gt; =&gt; {</span><br><span class="line">        this.messages.push(</span><br><span class="line">            {</span><br><span class="line">                role: 'system',</span><br><span class="line">                content: this.systemPrompt</span><br><span class="line">            }</span><br><span class="line">        );</span><br><span class="line">        this.messages.push(</span><br><span class="line">            {</span><br><span class="line">                role: 'user',</span><br><span class="line">                content: query</span><br><span class="line">            }</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        // 首次调用 OpenAI API</span><br><span class="line">        const completion = await this.openai.chat.completions.create({</span><br><span class="line">            model: MODEL as string,</span><br><span class="line">            messages: this.messages,</span><br><span class="line">            max_tokens: 1024,</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        let currentResponse = completion.choices[0].message.content;</span><br><span class="line"></span><br><span class="line">        // 检查响应是否包含工具调用标签</span><br><span class="line">        if (currentResponse &amp;&amp; currentResponse.includes('&lt;use_mcp_tool&gt;')) {</span><br><span class="line">            try {</span><br><span class="line">                // 将 LLM 的回复添加到消息历史</span><br><span class="line">                this.messages.push({</span><br><span class="line">                    role: 'assistant',</span><br><span class="line">                    content: currentResponse</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">                // 解析工具调用信息</span><br><span class="line">                const [serverName, toolName, toolArgs] = this.parseToolString(currentResponse);</span><br><span class="line"></span><br><span class="line">                // 记录工具调用详情</span><br><span class="line">                console.log(`[Calling tool ${toolName} with args ${JSON.stringify(toolArgs)}]`);</span><br><span class="line">                console.log('-'.repeat(40));</span><br><span class="line">                console.log("Server:", serverName);</span><br><span class="line">                console.log("Tool:", toolName);</span><br><span class="line">                console.log("Args:", JSON.stringify(toolArgs));</span><br><span class="line">                console.log('-'.repeat(40));</span><br><span class="line"></span><br><span class="line">                // 调用工具</span><br><span class="line">                const session = this.sessions.get(serverName);</span><br><span class="line">                if (!session) {</span><br><span class="line">                    const errorContent = `[错误: 服务器 ${serverName} 未连接或找不到工具 ${toolName}]`;</span><br><span class="line">                    console.error(errorContent);</span><br><span class="line">                    // 将错误消息作为用户消息添加到消息历史，供 LLM 处理</span><br><span class="line">                    this.messages.push({</span><br><span class="line">                        role: 'user',</span><br><span class="line">                        content: `[工具 ${toolName} 返回错误: ${errorContent}]`</span><br><span class="line">                    });</span><br><span class="line">                } else {</span><br><span class="line">                    const toolResult = await session.callTool({ name: toolName, arguments: toolArgs });</span><br><span class="line"></span><br><span class="line">                    // 记录工具结果</span><br><span class="line">                    const toolResultText = toolResult.content ? JSON.stringify(toolResult.content) : '无内容';</span><br><span class="line">                    console.log("Result:", toolResultText);</span><br><span class="line">                    console.log('-'.repeat(40));</span><br><span class="line"></span><br><span class="line">                    // 将工具结果作为新的用户消息添加到消息历史</span><br><span class="line">                    this.messages.push({</span><br><span class="line">                        role: 'user',</span><br><span class="line">                        content: `[Tool ${toolName} returned: ${toolResultText}]` // 将工具结果内容 JSON 字符串化</span><br><span class="line">                    });</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                // 使用更新后的消息进行第二次 API 调用</span><br><span class="line">                const secondCompletion = await this.openai.chat.completions.create({</span><br><span class="line">                    model: MODEL as string,</span><br><span class="line">                    messages: this.messages,</span><br><span class="line">                    max_tokens: 1024,</span><br><span class="line">                });</span><br><span class="line">                currentResponse = secondCompletion.choices[0].message.content;</span><br><span class="line"></span><br><span class="line">            } catch (error) {</span><br><span class="line">                console.error('处理工具调用出错:', error);</span><br><span class="line">                // 将错误消息作为用户消息添加到消息历史，供 LLM 处理</span><br><span class="line">                this.messages.push({</span><br><span class="line">                    role: 'user',</span><br><span class="line">                    content: `[工具调用失败: ${error instanceof Error ? error.message : String(error)}]`</span><br><span class="line">                });</span><br><span class="line">                // 使用错误消息进行第二次 API 调用</span><br><span class="line">                const secondCompletion = await this.openai.chat.completions.create({</span><br><span class="line">                    model: MODEL as string,</span><br><span class="line">                    messages: this.messages,</span><br><span class="line">                    max_tokens: 1024,</span><br><span class="line">                });</span><br><span class="line">                currentResponse = secondCompletion.choices[0].message.content;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        return currentResponse; // 返回最终响应（首次或工具调用后）</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    // 聊天循环</span><br><span class="line">    chatLoop = async () =&gt; {</span><br><span class="line">        console.log('\nMCP Client Started!');</span><br><span class="line">        console.log("Type your queries or 'quit' to exit.");</span><br><span class="line"></span><br><span class="line">        const rl = readline.createInterface({</span><br><span class="line">            input: process.stdin,</span><br><span class="line">            output: process.stdout,</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        try {</span><br><span class="line">            // 清空消息历史，只在循环开始前清空一次</span><br><span class="line">            this.messages = [];</span><br><span class="line">            while (true) {</span><br><span class="line">                const query = await rl.question('\nQuery: ');</span><br><span class="line"></span><br><span class="line">                if (query.toLowerCase() === 'quit') {</span><br><span class="line">                    rl.close(); // 关闭 readline 接口</span><br><span class="line">                    break; // 退出循环</span><br><span class="line">                }</span><br><span class="line">                if (query.trim() === '') {</span><br><span class="line">                    console.log("Please enter a query.");</span><br><span class="line">                    continue;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                const response = await this.processQuery(query);</span><br><span class="line"></span><br><span class="line">                // 打印最终响应</span><br><span class="line">                // Print the final response</span><br><span class="line">                console.log('Answer:', response);</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        } catch (error) {</span><br><span class="line">            console.error('\nError:', error);</span><br><span class="line"></span><br><span class="line">        } finally {</span><br><span class="line">            rl.close();</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    // 清理资源</span><br><span class="line">    cleanup = async (): Promise&lt;void&gt; =&gt; {</span><br><span class="line">        console.log("\nInitiating cleanup...");</span><br><span class="line">        // 遍历 transports 进行关闭</span><br><span class="line">        for (const transport of this.transports.values()) {</span><br><span class="line">            try {</span><br><span class="line">                await transport.close();</span><br><span class="line">                console.log("Closed transport.");</span><br><span class="line">            } catch (error) {</span><br><span class="line">                console.error("Error closing transport:", error);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        this.transports.clear();</span><br><span class="line">        this.sessions.clear();</span><br><span class="line">        console.log("Cleanup complete.");</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    // 检查是否有活动的会话</span><br><span class="line">    hasActiveSessions(): boolean {</span><br><span class="line">        return this.sessions.size &gt; 0;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// 主函数</span><br><span class="line">async function main() {</span><br><span class="line">    const client = new McpClient();</span><br><span class="line">    const mcpConfigFile = path.join(process.cwd(), 'mcp.json');</span><br><span class="line">    try {</span><br><span class="line">        // 1. 初始化客户端（读取 prompt 文件）</span><br><span class="line">        await client.initialize();</span><br><span class="line"></span><br><span class="line">        // 2. 加载配置并连接服务器</span><br><span class="line">        await client.loadConfigAndConnectServers(mcpConfigFile);</span><br><span class="line"></span><br><span class="line">        // 3. 只有在成功连接至少一个服务器时才启动聊天循环</span><br><span class="line">        if (!client.hasActiveSessions()) {</span><br><span class="line">            console.error("未建立任何活动的 MCP 会话。正在退出。");</span><br><span class="line">            // 即使没有连接服务器，也调用 cleanup 确保 readline 等资源被释放</span><br><span class="line">            await client.cleanup();</span><br><span class="line">            process.exit(1); // 以非零状态码退出表示错误</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        // 4. 启动聊天循环</span><br><span class="line">        await client.chatLoop();</span><br><span class="line"></span><br><span class="line">    } catch (error) {</span><br><span class="line">        // 捕获初始化或加载配置阶段可能发生的错误</span><br><span class="line">        console.error('初始化、配置加载或运行时错误:', error);</span><br><span class="line">        // 确保在发生错误时也执行清理</span><br><span class="line">        await client.cleanup();</span><br><span class="line">        process.exit(1); // 以非零状态码退出表示错误</span><br><span class="line">    } finally {</span><br><span class="line">        await client.cleanup();</span><br><span class="line">        process.exit(0);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">main().catch(console.error);</span><br></pre></td></tr></tbody></table></figure>
<p>效果如图：<br>
<img src="mcp-10.png" alt=""></p>
<p>总结：现在已经实现了MCP Client的搭建，通过加载mcp.json配置文件，即可加载所有的MCP Server，通过验证所有的MCP Server都可以加载成功。</p>
<blockquote>
<p>参考：<br>
使用JsNode搭建MCP-Client：<br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30869685315">https://zhuanlan.zhihu.com/p/30869685315</a><br>
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/1891179397081448675">https://zhuanlan.zhihu.com/p/1891179397081448675</a><br>
了解MCP与LLM之间的交互过程和日志：<br>
<a target="_blank" rel="noopener" href="https://blog.chengchao.name/2025/04/03/write-a-sample-mcp-client/">https://blog.chengchao.name/2025/04/03/write-a-sample-mcp-client/</a><br>
从0开始搭建MCP-Server和MCP-Client教程：<br>
<a target="_blank" rel="noopener" href="https://blog.minglog.cn/2025/04/18/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0MCP-Server/">https://blog.minglog.cn/2025/04/18/从0开始实现MCP-Server/</a><br>
<a target="_blank" rel="noopener" href="https://blog.minglog.cn/2025/04/21/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E5%AE%9E%E7%8E%B0MCP-Client/">https://blog.minglog.cn/2025/04/21/从0开始实现MCP-Client/</a><br>
<a target="_blank" rel="noopener" href="https://platform.moonshot.cn/console/api-keys">https://platform.moonshot.cn/console/api-keys</a><br>
理解MCP生命周期：<br>
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/CareySon/p/18827525/mcp_lifecycle_via_demo">https://www.cnblogs.com/CareySon/p/18827525/mcp_lifecycle_via_demo</a></p>
</blockquote>
<p align="center">    
<img src="nanie.jpg" width="200">
</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zhaoSpring.github.io">yxsct</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zhaospring.github.io/2025/06/10/mcp-client/">https://zhaospring.github.io/2025/06/10/mcp-client/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zhaoSpring.github.io" target="_blank">yxsct's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ai/">ai</a></div><div class="post-share"><div class="social-share" data-image="/2025/06/10/mcp-client/mcp-cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/cat2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info-name">yxsct</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zhaoSpring"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">MCP-Client介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMCP-Client"><span class="toc-number">1.1.</span> <span class="toc-text">什么是MCP-Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%B0%E6%9C%89%E7%9A%84MCP-Client"><span class="toc-number">1.2.</span> <span class="toc-text">现有的MCP-Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%87%AA%E5%B7%B1%E5%86%99MCP-Client%EF%BC%9F"><span class="toc-number">1.3.</span> <span class="toc-text">为什么要自己写MCP-Client？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">MCP调用流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">搭建MCP Client应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.1.</span> <span class="toc-text">准备模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MCP-Prompt"><span class="toc-number">3.2.</span> <span class="toc-text">MCP-Prompt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5MCP%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">引入MCP配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.4.</span> <span class="toc-text">实现通信协议</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/25/rebase-merge/" title="git rebase 与 merge区别"><img src="/2025/06/25/rebase-merge/rebase-merge-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="git rebase 与 merge区别"></a><div class="content"><a class="title" href="/2025/06/25/rebase-merge/" title="git rebase 与 merge区别">git rebase 与 merge区别</a><time datetime="2025-06-25T02:00:00.000Z" title="发表于 2025-06-25 10:00:00">2025-06-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/10/mcp-client/" title="从0开始编写mcp client"><img src="/2025/06/10/mcp-client/mcp-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="从0开始编写mcp client"></a><div class="content"><a class="title" href="/2025/06/10/mcp-client/" title="从0开始编写mcp client">从0开始编写mcp client</a><time datetime="2025-06-10T02:00:00.000Z" title="发表于 2025-06-10 10:00:00">2025-06-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/13/px-dp/" title="px、dp理解"><img src="/2025/05/13/px-dp/px-dp-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="px、dp理解"></a><div class="content"><a class="title" href="/2025/05/13/px-dp/" title="px、dp理解">px、dp理解</a><time datetime="2025-05-13T02:00:00.000Z" title="发表于 2025-05-13 10:00:00">2025-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/12/rust-5/" title="rust学习笔记5-所有权"><img src="/2025/02/12/rust-5/rust5-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rust学习笔记5-所有权"></a><div class="content"><a class="title" href="/2025/02/12/rust-5/" title="rust学习笔记5-所有权">rust学习笔记5-所有权</a><time datetime="2025-02-12T02:00:00.000Z" title="发表于 2025-02-12 10:00:00">2025-02-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/11/rust-4/" title="rust学习笔记4-控制流"><img src="/2025/02/11/rust-4/rust4-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rust学习笔记4-控制流"></a><div class="content"><a class="title" href="/2025/02/11/rust-4/" title="rust学习笔记4-控制流">rust学习笔记4-控制流</a><time datetime="2025-02-11T08:30:00.000Z" title="发表于 2025-02-11 16:30:00">2025-02-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">©2024 - 2026 By yxsct</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css')
    if (true) {
      await btf.getScript('https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  const initGitalk = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyGitalk = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const gitalk = new Gitalk({
      clientID: 'Ov23liMNExzpnW19di2C',
      clientSecret: 'a368280dcd3590374b18333b3fefdbdda2e5f1fc',
      repo: 'zhaospring.github.io',
      owner: 'zhaoSpring',
      admin: ['zhaoSpring'],
      updateCountCallback: commentCount,
      ...option,
      id: isShuoshuo ? path : (option && option.id) || '72d803078db91709a4d3a70b977592b9'
    })

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async(el, path) => {
    if (typeof Gitalk === 'function') initGitalk(el, path)
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk(el, path)
    }
  }

  if (isShuoshuo) {
    'Gitalk' === 'Gitalk'
      ? window.shuoshuoComment = { loadComment: loadGitalk }
      : window.loadOtherComment = loadGitalk
    return
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>